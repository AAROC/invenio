{#
## This file is part of Invenio.
## Copyright (C) 2012 CERN.
##
## Invenio is free software; you can redistribute it and/or
## modify it under the terms of the GNU General Public License as
## published by the Free Software Foundation; either version 2 of the
## License, or (at your option) any later version.
##
## Invenio is distributed in the hope that it will be useful, but
## WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
## General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with Invenio; if not, write to the Free Software Foundation, Inc.,
## 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.
#}
{% from "_formhelpers.html" import render_filter_form with context %}
{% from "websearch_helpers.html" import collection_tree, portalbox_sidebar, search_also, search_form, record_brief_links with context %}
{% from "websearch_results.html" import render_search_results with context %}
{% extends "page.html" %}
{% set title = collection.name_ln if collection.id > 1 else None %}

{%- set portalboxes = dict() -%}
{%- for k,l in collection.portalboxes_ln|groupby('position') -%}
  {%- do portalboxes.update({k:l}) -%}
{%- endfor -%}

{% block breadcrumb %}
{% endblock %}

{% block title %}
  {{ portalboxes.tp }}
  {{ super() }}
  {{ portalboxes.te }}
{% endblock %}
{% block header %}
  {{ super() }}
  {% js "js/websearch_typeahead.js" %}
  {% js "js/websearch_facet.js" %}
  {%- set args = request.args.copy().to_dict() -%}
  {%- set jrec = (pagination.page-2)*pagination.per_page+1 if pagination.has_prev else 1 -%}
  {%- do args.update({'jrec': jrec}) -%}
  {%- if pagination.has_prev -%}
  <link rel="prev" href="{{ url_for(request.endpoint, **args) }}"/>
  {%- endif -%}
  {%- if pagination.has_next -%}
  {%- set jrec = (pagination.page)*pagination.per_page+1 if pagination.has_next else (pagination.pages-1)*pagination.per_page+1 -%}
  {%- do args.update({'jrec': jrec}) -%}
  <link rel="next" href="{{ url_for(request.endpoint, **args) }}"/>
  {%- endif -%}
{% endblock %}


{% block body %}
<style>
.modal-backdrop {
  /* Show lighter modal window for search. */
  background-color: rgba(255,255,255,0.5);
}

#facet_list .accordion-heading {
  background-color: whiteSmoke;
}

#facet_list .accordion-heading a:after {
  content: ' ';
  float: right;
  display: inline-block;
  width: 14px;
  height: 14px;
  line-height: 14px;
  vertical-align: text-top;
  background-image: url("../img/glyphicons-halflings.png");
  background-position: 14px 14px;
  background-repeat: no-repeat;
  /* list alt */
  background-position: -264px -24px;
}


#facet_list {
}

#facet_list.affix {
  top: 60px;
}

body {
  position: relative;
}

#facet_list.affix-bottom {
  position: absolute;
  top: auto;
  bottom: 170px;
}

</style>


{{ search_form(collection) }}


{% if not recids|length %}

<div class="row">
  <div class="span12">
    <p>
      <strong>{{ _('Your search did not match any records. Please try again.') }}</strong>
    </p>
    {{ create_nearest_terms_box()|safe }}
  </div>
</div>

{% else %}

<div class="row">
  <div class="span2 visible-desktop">
    <div class="row">
    <div
      class="accordion span2"
      id="facet_list">
    </div>
    </div>
  </div>

  <div class="span10">

    <div class="row visible-desktop">
      <div class="span10">
        <div class="well" id="facet_filter" style="clear:both; display: none;">
          <input type="hidden" value="{{ request.args.get('p', '') }}" name="p" />
        </div>
      </div>
    </div>
    <div class="row">
      <div id="search_results" class="span10">
        {{ render_search_results(recids, collection, pagination, format_record) }}
      </div>
    </div>
  </div>
</div>

<div class="modal hide" id="overlay">
  <div class="modal-body">
    <center>
    <img alt="" src="/img/loading.gif" id="img-load" />
    <strong>{{ _('Filtering') }} ...</strong>
    </center>
  </div>
</div>

<script>
(function($) {

    // side facet list
    $('#facet_list').affix({
      offset: {
        top: function () {
          var $s = $('#search-box-main'),
              h = $s.height(),
              y = $s.offset()['top']
          return $(window).width() <= 980 ? 165 : h }
      , bottom: 170
      }
    })

  $('#overlay').modal({
      keyboard: false,
      backdrop: 'static'
  }).modal('hide');

  $('#facet_list').facet({
    controls_builder: function() { return ''; },
    control_button_builder: function(title) { return ''; },
    row_builder: function(data, name) {
      var span_style =  'display: inline-block;' +
                        'white-space: nowrap;' +
                        'width: 50%;' +
                        'overflow: hidden;' +
                        'text-overflow: ellipsis;',
          title = data[(data.length==3)?2:0];

      return '<div class="controls" style="margin-bottom: 2px; line-height: 14px; font-size: 10px; display:none;">'+
                '<i style="margin-top: -2px; cursor:pointer;" class="icon icon-filter" ' +
    'onclick="$(\'#facet_list\').data(\'facet\').addFacet(\'+\',\'' +
  name + '\',\'' + data[0] + '\');"></i>' +
                '<i style="margin-top: -2px; cursor:pointer;" class="icon icon-minus" ' +
    'onclick="$(\'#facet_list\').data(\'facet\').addFacet(\'-\',\'' +
  name + '\',\'' + data[0] + '\');"></i> <span title="'+title+'" style="'+ span_style +'">' +
                title +
            '</span> <span class="pull-right">(' + data[1] + ')</span>'+
            '<div style="clear:both;"></div></div>';
    },

    clear_button_builder: function(title) {
      return '<span class="pull-right btn btn-danger">'+title+'</span> \
              <span onclick="$(\'form[name=search]\').submit()" class="btn">\
              <i class="icon icon-ok"></i> {{ _('Apply') }}</span> \
              <div style="clear:both;"></div>';
    },
    filter: $('#facet_filter'),
    facets: {{ facets|tojson|safe }},
    title_clear: '<i class="icon icon-ban-circle icon-white"></i> {{ _('Clear') }}',
    title_more: '<i class="icon icon-chevron-down"></i> {{ _('More') }}',
    title_less: '<i class="icon icon-chevron-up"></i> {{ _('Less') }}',
    title_exclude: '{{ _('Exclude') }}', // translationable title
    title_limit_to: '{{ _('Limit to') }}', // translationable title
  }).on('updated', function(event) {
    var p = $('#facet_filter input[name=p]').val();
    $('#search-box-main input[name=p]')
      .val(p+' '+$('#facet_list').data('facet').queryString());

      var filter = JSON.stringify($('#facet_list').data('facet').filter);
      if (filter != document.location.hash.substr(1)) {
        if (filter != '{"+":{},"-":{}}') {
          document.location.hash = filter;
        } else {
          document.location.hash = '';
        }
      }

      var showModal = true;
      var modalShow= function() {
        if (showModal) {
          $("#overlay").modal('show');
        }
      };
      setTimeout(modalShow, 100);
      $.ajax('{{ url_for('.results', qid=qid) }}', {
        type: 'POST',
        data: $.extend( {},
        {{ request.args.to_dict()|tojson|safe }}
        ,{
          'filter': filter
        })
      }).done(function(data) {
        $('#search_results').html(data);
        showModal = false;
        $("#overlay").modal('hide');
      });

  }).on('loaded', function(event) {
    var typeahead = $('form[name=search] input[name=p]').data('typeahead');
    if ($.inArray(event.name+':', typeahead.options.source)<0) {
      $('form[name=search] input[name=p]').data('typeahead')
        .options.source.push(event.name+':');
    }
    $('form[name=search] input[name=p]').data('typeahead')
      .options.sources[event.name] = $.map(event.facet, function(i) {
        return i[0];
      });

    $('#facet_list i.icon-filter').tooltip({
      'title':'{{ _('Limit to')}}'
    , 'placement': 'right'
    });
    $('#facet_list i.icon-minus').tooltip({
      'title':'{{ _('Exclude')}}'
    , 'placement': 'right'
    });

    $('#search_results').css('min-height', $('#facet_list').height())
    $('#facet_list').affix('checkPosition');
  }).on('exists', function(event) {
    alert('{{ _('An item is already in the facet filter.') }}');
  });

  // Enable tooltips.
  $('[rel=tooltip]').tooltip();

  // Rebuild facet filter on hash change.
  $(window).bind('hashchange', function() {
    var hash_filter = jQuery.parseJSON(document.location.hash.substr(1));
    if (JSON.stringify($('#facet_list').data('facet').filter) != hash_filter) {
      $('#facet_list').data('facet').rebuildFilter(hash_filter || {});
    }
  });

  // Trigger history change.
  if (document.location.hash.length > 2) {
    $(window).trigger('hashchange');
  }

})(jQuery);

</script>

{% endif %}

{% endblock %}
