{#
## This file is part of Invenio.
## Copyright (C) 2012 CERN.
##
## Invenio is free software; you can redistribute it and/or
## modify it under the terms of the GNU General Public License as
## published by the Free Software Foundation; either version 2 of the
## License, or (at your option) any later version.
##
## Invenio is distributed in the hope that it will be useful, but
## WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
## General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with Invenio; if not, write to the Free Software Foundation, Inc.,
## 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.
#}

{% from "_formhelpers.html" import render_field with context %}

{% macro collection_tree(collection, children ) %}

<style>
    .list_placeholder { 
        height: 1.5em; line-height: 1.2em; 
        border: 0.2em dashed #ccc;
        border-radius-topright: 30px 20px;
        border-radius-topleft: 30px 20px;
    }
    .subnode_dropspace {
        height: 0.2em;
    }
</style>
<ul class="nav nav-list">
    <li class="nav-header">Document Server</li>
<ul {{ kwargs|xmlattr }}  data-id="{{ collection.id }}" data-score="{{collection.score}}">
    <li class="subnode_dropspace"> </li>
    {% for c in collection|attr(children) recursive %}
    <li data-id="{{ c.id }}" data-type="{{ c.type }}" data-score="{{c.score}}">
    {% if c.type == 'v' %}
    <i>
    <a  href="{{ url_for(".manage_collection", name=c.name) }}" >
        {{ c.name }}
    </a>
    </i>
    {% else %}
    <a  href="{{ url_for(".manage_collection", name=c.name) }}" >
        {{ c.name }}
    </a>
    {% endif %}
    <ul {{ kwargs|xmlattr }} data-id="{{ c.id }}" data-score="{{c.score}}">
        {# this makes possible adding a subchild to the leaf nodes #}
        <li class="subnode_dropspace"> </li>
    {% if c.collection_children %}
        {{ loop(c.collection_children) }}
    {% endif %}
    </ul>
    </li>
    {% endfor %}
    <li class="subnode_dropspace"> </li>
</ul>
</ul>

<script>
    // this sets the placeholders on the tree to drop the dragged element
    function set_placeholders(ui) {
        // removes the older placeholders
        $(".temp_placeholder").remove();

        // Adds a placeholder at the bottom of the list
        if ($(ui.placeholder).parent().children().size() > 2 ) {
            $(ui.placeholder).parent().append('<li class="list_placeholder temp_placeholder"></li>');
        }
        // this doesn't allow two placeholders next to each other
        $(ui.placeholder).prev(".temp_placeholder").remove();
        $(ui.placeholder).next(".temp_placeholder").remove();
    }

    // drag and drop JS code 
    $(function() {
        $( ".sortable" ).sortable({
            connectWith: ".connectedSortable",
            placeholder: "list_placeholder",
            cursor: "move",
            start: function(event, ui) {
                set_placeholders(ui);
            },
            change: function(event, ui) {
                set_placeholders(ui);
            },
            stop: function(event, ui) {
                // Removes the temporary placeholders from the tree 
                $(".temp_placeholder").remove();

                // Makes the ajax request
                $.ajax( '{{url_for('.modifycollectiontree')}}', {
                    type: 'GET',
                    data: 'id='+ $(ui.item).attr("data-id") +
                    "&id_dad="+$(ui.item).parent().attr("data-id") + "&score=" +
                    ui.item.index() + "&type=" + $(ui.item).parent().attr("data-type") }
                ).done(function(data) {})

            }
        });
        $( ".sortable" ).disableSelection();


    });
</script>
{% endmacro %}

{% macro collection_translations(collection) %}
<div {{ kwargs|xmlattr }}>
    <h2>Modify translations</h2>
    {% if config.CFG_LANGUAGE_LIST_LONG %}
        <form class="form-horizontal" method="POST" action="{{ url_for('.update_translations', id=collection.id) }}">
        {% for field in translation_form%}
              {{ render_field(field)}}
        {% endfor %}
        <div class="form-actions">
            <p><input type="submit" name="send_button" value="{{ _("Send") }}" class="btn
            btn-primary"/></p>
        </div>
        </form>
    {% endif %}
</div>
{% endmacro %}

{% macro portalboxes_admin(collection) %}
    <a href="#" >Create a new portalbox</a>

    <ul id="sortable" class="nav nav-list" data-id="{{ collection.id }}">
    {% for k,l in collection.portalboxes_ln|groupby('position') -%}
        {% for portalbox in l %}
        <li data-id="{{portalbox.id_portalbox}}" data-score="{{portalbox.score}}">
        <a href="#" data-id="{{ portalbox.id }}" class="modalloader" >{{ portalbox.portalbox.title }}</a>
        </li>   
        {% endfor %}
    {% endfor %}
    </ul>

<script>

    $(function() {
        $( "#sortable" ).sortable(
        {
            cursor: "'move",
            stop: function(event, ui) {
                $.ajax( '{{url_for('.manage_portalboxes_order')}}', {
                    type: 'GET',
                    data: 'id='+ $(ui.item).attr("data-id") +
                    "&id_collection="+$(ui.item).parent().attr("data-id") + "&score=" +
                    ui.item.index() 
                }
                ).done(function(data) {});
            }
        });

        /*$("a.modalloader").each(
        $(this).click(function(){
            $.ajax( '{{url_for('.edit_portalbox')}}', {
                type: 'GET',
                data: 'id='+ $(ui.item).attr("data-id") 
              }
            ).done(function(data) {});
          });
        );*/
    });
</script>

{% endmacro %}



